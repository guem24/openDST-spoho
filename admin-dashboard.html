<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Stress Test - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
            padding: 40px;
        }

        .section-header {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 40px 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
        }

        .section-header:first-of-type {
            margin-top: 30px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin: 20px 0 30px 0;
        }

        .insights-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 24px;
            margin: 20px 0 30px 0;
        }

        .chart-card {
            background: #f8f9fa;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        @media (max-width: 768px) {
            .charts-container,
            .insights-container {
                grid-template-columns: 1fr;
            }
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 200px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #28a745;
            color: white;
        }

        .btn-secondary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #28a745;
        }

        .info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid #2196F3;
        }

        .info h3 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .info p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .recent-list {
            margin-top: 30px;
        }

        .recent-list h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .recent-list ul {
            list-style: none;
        }

        .recent-list li {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Digital Stress Test</h1>
        <p class="subtitle">Sporthochschule Köln - Admin Dashboard</p>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalParticipants">-</h3>
                <p>Teilnehmer insgesamt</p>
            </div>
            <div class="stat-card">
                <h3 id="lastResponse">-</h3>
                <p>Letzte Antwort</p>
            </div>
        </div>

        <div class="buttons">
            <button class="btn-primary" id="refreshBtn" onclick="loadStats()">
                <span>Aktualisieren</span>
            </button>
            <button class="btn-secondary" id="exportBtn" onclick="exportToCSV()">
                <span>Daten als CSV exportieren</span>
            </button>
        </div>

        <div id="message"></div>

        <h2 class="section-header">Participant Data</h2>
        <div class="charts-container">
            <div class="chart-card">
                <h3>Geschlechterverteilung</h3>
                <div class="chart-wrapper">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Teilnahmen über Zeit</h3>
                <div class="chart-wrapper">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <h2 class="section-header">Data Insights</h2>
        <div class="insights-container">
            <div class="chart-card">
                <h3>Altersverteilung & Stress-Level</h3>
                <div class="chart-wrapper">
                    <canvas id="ageStressChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>VAS Stress-Progression (Baseline → End)</h3>
                <div class="chart-wrapper">
                    <canvas id="vasProgressionChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Mathe-Performance vs. Sprach-Qualität</h3>
                <div class="chart-wrapper">
                    <canvas id="performanceCorrelationChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Emotionale Zustandsveränderung (PANAS)</h3>
                <div class="chart-wrapper">
                    <canvas id="panasChangeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="info">
            <h3>Verwendung</h3>
            <p><strong>Aktualisieren:</strong> Zeigt die neuesten Statistiken an</p>
            <p><strong>CSV exportieren:</strong> Lädt alle Teilnehmerdaten als Excel-kompatible CSV-Datei herunter</p>
            <p><strong>Datenschutz:</strong> Teilen Sie diese URL nicht öffentlich. Alle Daten werden sicher in Ihrer Supabase-Datenbank gespeichert.</p>
        </div>

        <div class="recent-list" id="recentList"></div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://kkknomiduufcafoykvwb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtra25vbWlkdXVmY2Fmb3lrdndiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5OTYwOTUsImV4cCI6MjA3OTU3MjA5NX0.H7DaFE90vx_iawoYJUp4BbDNUFA5PDUrfpYGOZTdcQQ';

        const headers = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        };

        // Chart instances
        let genderChart = null;
        let timelineChart = null;
        let ageStressChart = null;
        let vasProgressionChart = null;
        let performanceCorrelationChart = null;
        let panasChangeChart = null;

        // Load stats on page load
        window.addEventListener('DOMContentLoaded', loadStats);

        async function loadStats() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="loading"></span><span>Lädt...</span>';

            try {
                // Get total count
                const countResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/participants?select=count`,
                    { headers: { ...headers, 'Prefer': 'count=exact' } }
                );

                const count = countResponse.headers.get('Content-Range').split('/')[1];
                document.getElementById('totalParticipants').textContent = count;

                // Get recent participants
                const recentResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/participants?select=id,created_at,age,gender&order=created_at.desc&limit=5`,
                    { headers }
                );

                const recentData = await recentResponse.json();

                if (recentData.length > 0) {
                    const lastDate = new Date(recentData[0].created_at);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastDate) / 60000);

                    let timeAgo;
                    if (diffMinutes < 1) timeAgo = 'Gerade eben';
                    else if (diffMinutes < 60) timeAgo = `vor ${diffMinutes} Min.`;
                    else if (diffMinutes < 1440) timeAgo = `vor ${Math.floor(diffMinutes / 60)} Std.`;
                    else timeAgo = `vor ${Math.floor(diffMinutes / 1440)} Tagen`;

                    document.getElementById('lastResponse').textContent = timeAgo;

                    // Show recent list
                    const recentList = document.getElementById('recentList');
                    recentList.innerHTML = '<h3>Letzte Teilnehmer</h3><ul>' +
                        recentData.map(p => {
                            const date = new Date(p.created_at).toLocaleString('de-DE');
                            return `<li>Teilnehmer ${p.id.substring(0, 8)}... - ${date}</li>`;
                        }).join('') +
                        '</ul>';
                } else {
                    document.getElementById('lastResponse').textContent = 'Keine Daten';
                }

                // Fetch all participants for charts
                const allParticipantsResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/participants?select=gender,created_at&order=created_at.asc`,
                    { headers }
                );
                const allParticipants = await allParticipantsResponse.json();

                // Fetch comprehensive data for insights
                const comprehensiveDataResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/participant_complete_data?select=*`,
                    { headers }
                );
                const comprehensiveData = await comprehensiveDataResponse.json();

                // Update charts
                updateGenderChart(allParticipants);
                updateTimelineChart(allParticipants);
                updateAgeStressChart(comprehensiveData);
                updateVasProgressionChart(comprehensiveData);
                updatePerformanceCorrelationChart(comprehensiveData);
                updatePanasChangeChart(comprehensiveData);

                showMessage('Statistiken aktualisiert', 'success');
            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('Fehler beim Laden der Statistiken: ' + error.message, 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<span>Aktualisieren</span>';
            }
        }

        function updateGenderChart(participants) {
            const genderCounts = participants.reduce((acc, p) => {
                const gender = p.gender || 'Unbekannt';
                acc[gender] = (acc[gender] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(genderCounts).map(g => {
                if (g === 'male') return 'Männlich';
                if (g === 'female') return 'Weiblich';
                if (g === 'other') return 'Divers';
                return 'Unbekannt';
            });
            const data = Object.values(genderCounts);

            const ctx = document.getElementById('genderChart').getContext('2d');

            if (genderChart) {
                genderChart.destroy();
            }

            genderChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#cccccc'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTimelineChart(participants) {
            // Group by date
            const dateCounts = participants.reduce((acc, p) => {
                const date = new Date(p.created_at).toLocaleDateString('de-DE');
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            // Get last 14 days or all dates if less
            const dates = Object.keys(dateCounts).slice(-14);
            const counts = dates.map(date => dateCounts[date]);

            const ctx = document.getElementById('timelineChart').getContext('2d');

            if (timelineChart) {
                timelineChart.destroy();
            }

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Teilnehmer',
                        data: counts,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updateAgeStressChart(data) {
            // Filter out invalid data
            const validData = data.filter(p => p.age && p.speaking_tick_counter_q1 !== null);

            // Group by age brackets
            const ageBrackets = {
                '18-25': [],
                '26-35': [],
                '36-50': [],
                '51-65': [],
                '65+': []
            };

            validData.forEach(p => {
                const age = parseInt(p.age);
                // Calculate stress proxy (average of speaking metrics)
                const stressProxy = (
                    (p.speaking_tick_counter_q1 || 0) + (p.speaking_tick_counter_q2 || 0) + (p.speaking_tick_counter_q3 || 0) +
                    (p.speak_break_counter_q1 || 0) + (p.speak_break_counter_q2 || 0) + (p.speak_break_counter_q3 || 0) +
                    ((p.volume_high_q1 || 0) + (p.volume_high_q2 || 0) + (p.volume_high_q3 || 0)) / 10
                ) / 9;

                if (age >= 18 && age <= 25) ageBrackets['18-25'].push(stressProxy);
                else if (age >= 26 && age <= 35) ageBrackets['26-35'].push(stressProxy);
                else if (age >= 36 && age <= 50) ageBrackets['36-50'].push(stressProxy);
                else if (age >= 51 && age <= 65) ageBrackets['51-65'].push(stressProxy);
                else if (age > 65) ageBrackets['65+'].push(stressProxy);
            });

            // Calculate averages for each bracket
            const labels = Object.keys(ageBrackets);
            const averages = labels.map(bracket => {
                const values = ageBrackets[bracket];
                return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
            });

            const ctx = document.getElementById('ageStressChart').getContext('2d');
            if (ageStressChart) ageStressChart.destroy();

            ageStressChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Durchschnittlicher Stress-Index',
                        data: averages,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Stress-Index'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Altersgruppe'
                            }
                        }
                    }
                }
            });
        }

        function updateVasProgressionChart(data) {
            // Filter valid data
            const validData = data.filter(p =>
                p.vas_baseline_stress !== null &&
                p.vas_intermediate_stress !== null &&
                p.vas_end_stress !== null
            );

            if (validData.length === 0) {
                console.warn('No valid VAS data for chart');
                return;
            }

            // Calculate average stress levels at each timepoint
            const avgBaseline = validData.reduce((sum, p) => sum + (p.vas_baseline_stress || 0), 0) / validData.length;
            const avgIntermediate = validData.reduce((sum, p) => sum + (p.vas_intermediate_stress || 0), 0) / validData.length;
            const avgEnd = validData.reduce((sum, p) => sum + (p.vas_end_stress || 0), 0) / validData.length;

            // Also calculate other VAS metrics
            const avgFrustrated = [
                validData.reduce((sum, p) => sum + (p.vas_baseline_frustrated || 0), 0) / validData.length,
                validData.reduce((sum, p) => sum + (p.vas_intermediate_frustrated || 0), 0) / validData.length,
                validData.reduce((sum, p) => sum + (p.vas_end_frustrated || 0), 0) / validData.length
            ];

            const avgOverstrained = [
                validData.reduce((sum, p) => sum + (p.vas_baseline_overstrained || 0), 0) / validData.length,
                validData.reduce((sum, p) => sum + (p.vas_intermediate_overstrained || 0), 0) / validData.length,
                validData.reduce((sum, p) => sum + (p.vas_end_overstrained || 0), 0) / validData.length
            ];

            const ctx = document.getElementById('vasProgressionChart').getContext('2d');
            if (vasProgressionChart) vasProgressionChart.destroy();

            vasProgressionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Baseline', 'Intermediate', 'End'],
                    datasets: [
                        {
                            label: 'Stress',
                            data: [avgBaseline, avgIntermediate, avgEnd],
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: '#667eea',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Frustration',
                            data: avgFrustrated,
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            borderColor: '#764ba2',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Überforderung',
                            data: avgOverstrained,
                            backgroundColor: 'rgba(240, 147, 251, 0.2)',
                            borderColor: '#f093fb',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'VAS Score (0-100)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zeitpunkt'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updatePerformanceCorrelationChart(data) {
            // Filter valid data
            const validData = data.filter(p =>
                p.math_task_score !== null &&
                p.audio_mean_q1 !== null
            );

            if (validData.length === 0) {
                console.warn('No valid performance correlation data');
                return;
            }

            // Calculate average speech quality (audio mean across all questions)
            const dataPoints = validData.map(p => ({
                x: p.math_task_score,
                y: ((p.audio_mean_q1 || 0) + (p.audio_mean_q2 || 0) + (p.audio_mean_q3 || 0)) / 3
            }));

            const ctx = document.getElementById('performanceCorrelationChart').getContext('2d');
            if (performanceCorrelationChart) performanceCorrelationChart.destroy();

            performanceCorrelationChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Teilnehmer',
                        data: dataPoints,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Ø Sprach-Qualität (Audio Level)'
                            }
                        },
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Mathe-Score'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Score: ${context.parsed.x}, Audio: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePanasChangeChart(data) {
            const validData = data.filter(p =>
                p.panas_begin_active !== null &&
                p.panas_end_active !== null
            );

            // Calculate average PANAS scores for begin and end
            const panasMetrics = ['active', 'upset', 'hostile', 'inspired', 'ashamed', 'alert', 'nervous', 'determined', 'attentive', 'afraid'];

            const beginScores = panasMetrics.map(metric => {
                const values = validData.map(p => p[`panas_begin_${metric}`] || 0);
                return values.reduce((a, b) => a + b, 0) / values.length;
            });

            const endScores = panasMetrics.map(metric => {
                const values = validData.map(p => p[`panas_end_${metric}`] || 0);
                return values.reduce((a, b) => a + b, 0) / values.length;
            });

            const ctx = document.getElementById('panasChangeChart').getContext('2d');
            if (panasChangeChart) panasChangeChart.destroy();

            panasChangeChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Aktiv', 'Verärgert', 'Feindselig', 'Inspiriert', 'Beschämt', 'Wachsam', 'Nervös', 'Entschlossen', 'Aufmerksam', 'Ängstlich'],
                    datasets: [
                        {
                            label: 'Vor Test',
                            data: beginScores,
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            pointBackgroundColor: '#667eea'
                        },
                        {
                            label: 'Nach Test',
                            data: endScores,
                            backgroundColor: 'rgba(118, 75, 162, 0.2)',
                            borderColor: '#764ba2',
                            borderWidth: 2,
                            pointBackgroundColor: '#764ba2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 4,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        async function exportToCSV() {
            const exportBtn = document.getElementById('exportBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="loading"></span><span>Exportiere...</span>';

            try {
                // Fetch all participant data from the view
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/participant_complete_data?select=*`,
                    { headers }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.length === 0) {
                    throw new Error('Keine Daten zum Exportieren vorhanden');
                }

                // Convert to CSV
                const csv = convertToCSV(data);

                // Download file
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `stress-test-data-${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`${data.length} Teilnehmer erfolgreich exportiert!`, 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showMessage('Fehler beim Exportieren: ' + error.message, 'error');
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span>Daten als CSV exportieren</span>';
            }
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';

            // Get headers from first object
            const headers = Object.keys(data[0]);

            // Create CSV header row
            const headerRow = headers.join(',');

            // Create CSV data rows
            const dataRows = data.map(obj => {
                return headers.map(header => {
                    let value = obj[header];

                    // Handle null/undefined
                    if (value === null || value === undefined) {
                        return '';
                    }

                    // Convert to string and escape quotes
                    value = String(value).replace(/"/g, '""');

                    // Wrap in quotes if contains comma, newline, or quote
                    if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                        return `"${value}"`;
                    }

                    return value;
                }).join(',');
            }).join('\n');

            return headerRow + '\n' + dataRows;
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';

            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
